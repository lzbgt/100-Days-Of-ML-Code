# BMP581 储液罐测高demo算法设计方案备选

Lu Bruce (Draft)
---

## 算法模型

### 术语

- `p_raw` – BMP581 原始气压 [Pa]
- `T_raw` – BMP581 温度 [°C]
- `p_f` – 滤波后气压 [Pa]
- `p_ref` – 当前参考气压（对应高度 0）[Pa]
- `h_rel` – 相对高度（以当前 0 点为基准）[m]
- `h_uwb` – UWB 求出的高度 / 垂直位置 [m]
- `h_ref_uwb` – 基准点的 UWB 高度 [m]（通常设为 0 或已知标定值）
- `stationary_flag` – 静止检测标志（优先来自 IMU；无 IMU 时可由气压/温度方差推断）
- `moving_flag` – 运动标志
- `dt` – 采样周期 [s]

### 气压 → 高度转换模型（近似线性）
标准气压公式：

\[
p(h) = p_{ref} \exp\left(-\frac{M g h}{R T}\right)
\]

严格解：

\[
\Delta h_\text{true} = \frac{R T}{M g}\ln\frac{p_{ref}}{p}
\]

线性近似在参考点处常密度展开：

\[
\Delta h_\text{lin} \approx \frac{p_{ref} - p}{\rho_0 g},\quad \rho_0 = \frac{M p_{ref}}{R T}
\]

对高度差在 ±10 m 范围内，假设同温, 则可使用线性近似：

\[
\Delta h \approx \frac{p_\text{ref} - p}{\rho g}
\]

- 取 \(\rho \approx 1.2 \ \text{kg/m}^3\)、\(g \approx 9.81\ \text{m/s}^2\)
- 则 \(\rho g \approx 11.8\ \text{Pa/m}\)

所以：

\[
h_\text{rel} \approx K_p \cdot (p_\text{ref} - p_f), \quad K_p \approx 0.085\ \text{m/Pa}
\]

该近似公式在假定同温条件满足的情况下, 10m范围内与严格解的最大误差不超过6mm. 可以直观解读为每帕斯卡对应8.5厘米的高度差.

本文假定采用严格解因为温度差在储液罐10米高度有可能超过0.1℃.

### 静止检测（`stationary_flag` 生成）

- **IMU 优先**：0.5–1 s 滑窗，若加速度模长方差 < 阈值且角速度模长 < 阈值则判定静止。示例阈值：`std(|a|) < 0.02 g` 且 `|ω| < 3°/s`。
- **无 IMU 时的 baro/温度法**：1–2 s 窗口内同时满足 `std(p_f) < 0.3 Pa`（≈2.5 cm）且 `|Δp_f|_max < 0.5 Pa`，可加上 `std(T_raw) < 0.05℃`。采用滞回或多数表决避免抖动。
- **输出滞回**：静止→运动阈值放宽 1.5–2 倍，确保 `stationary_flag` 稳定，不因单个尖峰翻转。

---

## 方案A：自参考滚动刷新 + 手动 0 点设定 (本方案可以快速原型)

场景：

- 用户在 GUI 中选中标签，点击“计高”，人为定义当前高度为 0。
- 之后高度显示为相对高度，允许缓慢补偿环境气压缓漂移。

### 状态机设计

`HeightState ∈ {IDLE, ZERO_PENDING, ZEROED, RUNNING}`

- **IDLE**：未选择标签或零点未识别, 未开始计高。
- **ZERO_PENDING**：用户刚点击“计高”或系统刚识别零点，算法采集一段气压数据做平均作为 `p_ref`。
- **ZEROED**：`p_ref`, `t_ref` 已确定，可以输出相对高度。
- **RUNNING**：持续输出高度，并在满足条件时滚动微调 `p_ref`。

状态转移：

- IDLE → ZERO_PENDING：用户点击“计高”。
- ZERO_PENDING → ZEROED：收集 N 个样本（例如 1–3s）、求平均后设为 `p_ref`。
- ZEROED → RUNNING：开始计算相对高度。
- RUNNING 内部：根据“静止 & 漂移”条件小步更新 `p_ref`。

### 滤波与 0 点设定

1. 对 `p_raw` 使用一阶 IIR 低通滤波：

   \[
   p_f(k) = \alpha p_f(k-1) + (1-\alpha) p_\text{raw}(k)
   \]

> 实现备注：当前固件已将 BMP581 片上 IIR 设置为 **COEFF_3**（寄存值 0x2，系数 3，对应 -3 dB 归一化带宽 ≈0.046，即 fc≈0.92 Hz 在 ODR=20 Hz 下）。其离散一阶等效时间常数 τ≈0.17 s（95% 收敛 ≈0.52 s），属轻度平滑，可减小 MCU 侧所需的额外滤波。保持此设置时，主机侧 \(\alpha\) 可设得较“快”（例如 τ≈0.6–0.8 s）以兼顾响应和平滑。若现场存在明显风/摆动导致静压舱受扰，可将片上 IIR 调到 **COEFF_7**（fc≈0.43 Hz，τ≈0.37 s，95%≈1.12 s）或 **COEFF_15**（fc≈0.21 Hz，τ≈0.77 s，95%≈2.32 s），以更强抑制动态压扰动，代价是更大响应时延。时间常数随 ODR 线性缩放：τ ∝ 1/ODR。

2. 在 `ZERO_PENDING` 状态下，记录 `N_zero` 个 `p_f`（例如 5 s 数据），求平均：

   \[
   p_\text{ref0} = \frac{1}{N_\text{zero}} \sum_{i=1}^{N_\text{zero}} p_f(i)
   \]
3. `p_ref ← p_ref0`，状态切换到 `ZEROED/RUNNING`。

### 滚动自参考刷新（漂移补偿）

目标：

- 缓慢补偿大气变化（温度/天气），
- 但在标签明显移动时不去动 `p_ref`，避免把真实高度变化“吃掉”。

策略：

- 只在以下条件同时满足时做 **微小步长**的 `p_ref` 更新：
  - `stationary_flag == true`
  - 当前 `|h_rel| < H_lock`（例如 `H_lock = 0.3 m`，认为靠近原零点）
  - 一段时间内 `|Δp_f|` 很小（局部稳态）

更新公式：

\[
p_\text{ref}(k) = p_\text{ref}(k-1) + \beta \cdot (p_f(k) - p_\text{ref}(k-1))
\]

- `β` 很小，例如 `β = 0.001–0.01`（time constant 100–1000 samples）
- 实际上就是让 `p_ref` 以极慢的时间常数追踪长期漂移

### 高度计算与输出

在 `RUNNING` 状态：

\[
h_\text{rel}(k) = K_p \cdot (p_\text{ref}(k) - p_f(k))
\]

可以同时输出：

- 当前高度 `h_rel`
- 高度变化速度 `v_h ≈ (h_rel(k) - h_rel(k-1))/dt`
- 是否在“0 附近”（用于显示色块 / 提示）

### 用户侧行为

- 用户行为：
  - 选中标签 → 点击“计高” → 等待 1–2 秒稳定 → 开始拖动/移动传感器演示高度变化。
- 算法行为：
  - 初始 0 点由那 1–2 秒气压平均确定；
  - 后续在静止 & 近零时缓慢修正，以防 10–20 分钟内零点飘走。

---

## 方案 B：自参考滚动刷新 + UWB 自动参考设置

场景：

- 标签同时具备 UWB 定位和 BMP581。
- 当 UWB 判定标签处于某个**已知高度区域**（例如地面、罐底）时，自动设为 0 点，无需人手点“计高”。

### UWB 触发条件

设：

- `h_uwb` – 当前 UWB 解算的高度
- `h_ref_uwb` – 预设基准高度（例如罐底 = 1 m）
- `ε_zero` – UWB 判定阈值（例如 `0.3 m`）

自动 0 点触发条件：

\[
|h_\text{uwb} - h_\text{ref\_uwb}| < \varepsilon_\text{zero}
\]
且
`stationary_flag == true`（避免运动中误触发）

### 自动 0 点更新

当上述条件满足：

1. 进入 `ZERO_PENDING` 状态；
2. 采集 `N_zero` 个气压样本求平均得到 `p_ref0`；
3. 设置：

   \[
   p_\text{ref} \gets p_\text{ref0}
   \]
4. 将当前 UWB 高度标记为 0：

   \[
   h_\text{ref\_uwb} \gets h_\text{uwb}
   \]

   或直接在展示层中以 `(h_uwb - h_ref_uwb)` 为 UWB 相对高度。

### 自参考滚动刷新

滚动刷新规则与方案 A 相同，但触发不再由人工，而是由“UWB 识别到了在零高度附近”。

可选增强：

- 加入一个“自动 0 点锁定最小间隔”，例如 30 秒内只允许一次自动 0，防止 UWB 抖动频繁重置。
- 若 UWB 质量差（NLOS、低质量 flag），则禁止自动 0。

### 优点与注意点

- 优点：
  - 客户无需理解“点击计高”，系统自动在回到某个特定区域（例如罐底）后复位零点。
- 注意：
  - UWB 垂直精度通常差于水平，`ε_zero` 不宜设太小。
  - 如果 UWB z 坐标是通过多层 anchor 拟合出来的，要对 NLOS 做鲁棒处理（RANSAC / 权重剔除）。

---

## 方案 C：自参考滚动刷新 + 压力检测“门槛/踏板”触发自动 0

理解：

- “pressure detection paddle for human entrance” 可以理解为 **在入口/门口/特定位置，会出现一个可检测的气压扰动事件**（例如开门瞬间 / 通过一个狭窄空间）。
- 利用这个特征事件，在该位置自动设定 0 点。

### 事件检测逻辑（Δp / Δt）

利用气压时间序列的导数检测“门槛事件”：

\[
\Delta p(k) = p_f(k) - p_f(k-1)
\]

定义：

- `dp_thresh_high`：正向压力突变阈值
- `dp_thresh_low`：负向压力突变阈值

门槛事件触发条件（示例）：

\[
|\Delta p(k)| > dp_\text{thresh}
\]

且在短时间窗口内（例如 1–2 秒）观察到多次同向突变，或者通过一个简单的模式匹配（短时 oscillation 模式）。

### 事件 + 空间区域联合触发

为了避免纯噪声触发，建议将气压事件与空间 / UWB 条件结合：

- 条件 1：近似在入口区域（可由 UWB x-y 坐标判断，或 RSSI 区域）
- 条件 2：在短时间内观测到特定的 `Δp` pattern
- 条件 3：`moving_flag == true`（表明有人通过）

当三者都满足时，我们认为“人刚刚经过了入口/零点附近”。

### 自动 0 点设定

与方案 A/B 类似：

1. 进入 `ZERO_PENDING` 状态；
2. 在事件发生后的 `T_zero` 秒内，收集 `p_f` 做平均：

   \[
   p_\text{ref0} = \frac{1}{N_\text{zero}} \sum p_f
   \]
3. 更新 `p_ref ← p_ref0`；回到 `RUNNING` 状态。

### 滚动刷新

滚动刷新逻辑与方案 A 相同（静止且靠近 0 时微调 `p_ref`）。

### 适用场景与限制

- 适合场景：

  - 封闭空间 / 门洞进出时有明显气压扰动。
  - 特定“过门口 / 进入罐区”的动作是高度上“自然零点”。
- 限制：

  - 强风、空调、大门频繁开合可能产生误触发，需要区域限制 + IMU / UWB 辅助。
  - 如果气压扰动很小，则该方法不可靠，应退回方案 A/B。

---

## 方案 D：交叉参考 – 基站气压作为零点（有/无 UWB 标定）

场景：

- 有一个或多个固定位置的 **baro 基站**（安装在已知高度位置，例如地面 / 楼层基准）。
- 标签也有 BMP581。
- 目标：
  - 使用“基站气压 + 标签气压差”估算标签相对基站的高度。
  - 可选：引入 UWB 来自动标定 `K_p` 或修正 offset。

### 基本关系

- `p_base` – 基站气压滤波后值
- `p_tag` – 标签气压滤波后值

理想情况下：

\[
h_\text{rel} = K_p \cdot (p_\text{base} - p_\text{tag}) + b
\]

- `K_p`：Pa→m 的比例系数（理论上 ~0.085 m/Pa），可通过实验标定；
- `b`：静态偏置（例如传感器安装高度差、静压腔偏差）。

### 基站与标签的气压滤波

基站与标签各自做低通滤波：

\[
p_\text{base,f}(k) = \alpha_b p_\text{base,f}(k-1) + (1-\alpha_b)p_\text{base,raw}(k)
\]
\[
p_\text{tag,f}(k) = \alpha_t p_\text{tag,f}(k-1) + (1-\alpha_t)p_\text{tag,raw}(k)
\]

- 通常 `α_b` 取更大（例如 0.99），因为基站不动，只需要慢速追踪；
- `α_t` 可略小一点，与方案 A 相同。

### 预标定（实验室 / 现场一次性）

1. 在若干已知高度差位置（标签与基站高度差 `Δh_known`）下采集数据：

   - 测量 `Δp = p_base,f - p_tag,f`
   - 记录 `(Δp, Δh_known)` 对。
2. 用线性回归拟合：

   \[
   \Delta h_\text{known} \approx K_p \cdot \Delta p + b
   \]

   得到 `K_p` 与 `b`。
3. 将 `K_p`、`b` 固化为配置参数。之后运行时直接用：

   \[
   h_\text{rel}(k) = K_p \cdot (p_\text{base,f}(k) - p_\text{tag,f}(k)) + b
   \]
4. 对于长期 drift，由于基站和标签共同受天气/温度影响，大部分慢速漂移会被抵消，漂移主要来自传感器差异。

### 基于 UWB 的自动标定

当系统具备 UWB：

- 在多帧数据中，我们可以同时获得 `h_uwb` 与对应抽样时刻的 `Δp`：

  - `Δp_i = p_base,f(i) - p_tag,f(i)`
  - `h_uwb,i` 为 UWB 解算的高度差（或相对同一参考面的高度）
- 在一段时间内（例如 30–60 s 的运动数据），建立样本集：

  \[
  \{(\Delta p_i, h_{\text{uwb},i})\}
  \]
- 拟合模型：

  \[
  h_{\text{uwb},i} \approx K_p \cdot \Delta p_i + b
  \]

  通过最小二乘 / RANSAC 去除明显的 NLOS UWB 点，得到鲁棒估计的 `K_p`、`b`。

> 运行策略建议：
>
> - 标定阶段：开启“自动标定模式”，要求标签做若干次上下移动，让样本丰富。
> - 标定完成后：锁定 `K_p`、`b`，进入常规运行模式。

### 与自参考滚动刷新结合

即使有基站，我们仍可以在小范围内做“局部零点调整”：

- `h_rel` 由上式计算；
- 若检测到“标签静止且高度接近某个预期零点”（例如地面附近），可以对 `b` 做缓慢微调，而不重新拟合 `K_p`；
- 类似方案 A 中缓慢更新 `p_ref`，这里是缓慢更新 `b`：

  \[
  b(k) = b(k-1) + \gamma (h_\text{target} - h_\text{rel}(k-1))
  \]

  - `h_target` 通常为 0（地面）；
  - `γ` 很小（例如 1e-3–1e-4），避免破坏整体标定。

### 优点与限制

- 优点：

  - 能较好抵消大尺度气压变化（天气、温度），长期稳定性好；
  - 在楼层、厂区这种多点分布场景，可以统一高度基准。
- 限制：

  - 需要部署至少一个稳定的 baro 基站，并保证其静压环境稳定（不被风口干扰）；
  - 基站与标签传感器的差异、静压腔设计差异仍会反映到偏置 `b` 上，需要标定或逐渐修正。

---

## 方案比较

- **方案 A**：最简单，适合 Demo 和单点相对高度展示；用户操作一个“计高”按钮即可。
- **方案 B**：利用 UWB 自动识别“回到零点区域”来自动设零，适合 UWB 已经稳定部署的场景。
- **方案 C**：依赖气压扰动“事件”，适合有明显门洞/入口特征的场景；需谨慎设计阈值与区域。
- **方案 D**：通过基站 baro 做交叉参考，适合需要多点统一高度基准、长期运行的工业场景，可结合 UWB 自动标定减少人工工作量。

---

有关气压计的采样率和低通滤波:
压力量程带宽：手/臂/人体的晃动和标签上下晃动大约在 2–3 Hz；要做干净的滤波和求导，采样频率至少需要是它的 ≥10 倍 → 原始采样频率应 ≥20–30 Hz。
滤波稳定性：如果一阶低通的时间常数设在 0.5–1 s，而采样频率很低（例如 1–5 Hz），离散极点会被推到很接近 0，导致输出呈“台阶状”，收敛很慢；在 25–50 Hz 下，极点能保持在接近 1 的位置，输出更平滑、时延更低。
归零 / 稳定判定：需要在 1–2 s 窗口内有足够多采样点来判断压力是否稳定；25 Hz 时有 25–50 个样本，而 5 Hz 只有 5–10 个，鲁棒性差很多。
微分噪声：竖直速度来自 Δh/Δt；更高的采样频率可以减小量化误差和低通滤波引入的时延，使速度估计依然可用。
实际下限：尽量避免采样频率 <10 Hz；10 Hz 对运动追踪来说已经是勉强够用。原始数据在 25–50 Hz，显示刷新降采样到 5–10 Hz，是响应速度、噪声和功耗之间比较好的折中。

由于Lora带宽限制, 在1Hz上报平台的情况下, 可以在标签片上本地做低通滤波, 以帮助抑制噪声和运动引起的瞬时抖动.
低通滤波因子:  α = exp(-Ts/τ), 其中τ为滤波时间常数，Ts为采样间(1/F s). τ取 0.8s, ts=1/20 s, α=exp(-0.0625)≈0.94
